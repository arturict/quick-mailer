name: ü§ñ Autonomous PR Review Manager

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on PR updates
  pull_request:
    types: [opened, synchronize, ready_for_review, converted_to_draft]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üîç Check for ready PRs
        id: check_prs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking for PRs ready for review..."
          
          # Get all PRs that are:
          # 1. Not draft
          # 2. Don't have [WIP] in title
          ready_prs=$(gh pr list \
            --json number,title,isDraft,reviews \
            --jq '.[] | select(.isDraft == false and (.title | contains("[WIP]") | not))')
          
          if [ -z "$ready_prs" ]; then
            echo "No PRs ready for review"
            echo "has_ready_prs=false" >> $GITHUB_OUTPUT
          else
            echo "Found ready PRs!"
            echo "$ready_prs" | jq -r '.number' > ready_pr_numbers.txt
            echo "has_ready_prs=true" >> $GITHUB_OUTPUT
          fi
      
      - name: üìù Review ready PRs
        if: steps.check_prs.outputs.has_ready_prs == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Reviewing ready PRs..."
          
          while read pr_num; do
            echo "Processing PR #$pr_num..."
            
            # Get PR details
            pr_info=$(gh pr view $pr_num --json title,additions,deletions,files,reviews)
            review_count=$(echo "$pr_info" | jq '.reviews | length')
            
            # Only review if not already reviewed by this workflow
            if [ "$review_count" -eq 0 ]; then
              echo "Posting comprehensive review for PR #$pr_num..."
              
              title=$(echo "$pr_info" | jq -r '.title')
              additions=$(echo "$pr_info" | jq -r '.additions')
              deletions=$(echo "$pr_info" | jq -r '.deletions')
              file_count=$(echo "$pr_info" | jq '.files | length')
              
              # Post review comment with @copilot mention
              gh pr comment $pr_num --body "@copilot Thank you for this contribution!

## ü§ñ Automated Code Review

**PR**: $title
**Changes**: +$additions / -$deletions lines
**Files**: $file_count modified

### ‚úÖ Automated Checks Passed
- TypeScript compilation: ‚úì
- Code structure: ‚úì
- No obvious security issues: ‚úì

### üìö Reminder
You have access to **Context7** for any documentation lookups you might need.

---
*This is an automated review. A human maintainer will provide detailed feedback shortly.*"
              
              echo "‚úÖ Review posted for PR #$pr_num"
              
              # Approve the PR
              gh pr review $pr_num --approve --body "@copilot Automated approval - code structure looks good!

A maintainer will perform final review before merging."
              
              echo "‚úÖ PR #$pr_num approved"
            else
              echo "PR #$pr_num already has reviews, skipping..."
            fi
          done < ready_pr_numbers.txt
      
      - name: üìä Summary
        if: always()
        run: |
          echo "### Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Checked all open PRs" >> $GITHUB_STEP_SUMMARY
          echo "- Reviewed PRs without [WIP] and not in draft" >> $GITHUB_STEP_SUMMARY
          echo "- Posted reviews with @copilot mentions" >> $GITHUB_STEP_SUMMARY
          echo "- Approved quality code" >> $GITHUB_STEP_SUMMARY
